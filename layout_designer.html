<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»“åº“å¸ƒå±€è®¾è®¡å™¨</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background-color: #f5f5f5; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background-color: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; text-align: center; }
        .header h1 { font-size: 24px; margin-bottom: 10px; }
        .main-content { display: flex; min-height: 600px; }
        .control-panel { width: 350px; background-color: #f8f9fa; padding: 20px; border-right: 1px solid #e0e0e0; overflow-y: auto; }
        .preview-panel { flex: 1; padding: 20px; }
        .section { margin-bottom: 25px; }
        .section-title { font-size: 16px; font-weight: bold; margin-bottom: 15px; color: #333; border-bottom: 2px solid #667eea; padding-bottom: 5px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; font-size: 14px; }
        .form-group input, .form-group select { width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1); }
        .size-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 14px; transition: all 0.3s ease; }
        .btn-primary { background-color: #667eea; color: white; }
        .btn-primary:hover { background-color: #5a67d8; }
        .btn-secondary { background-color: #48bb78; color: white; }
        .btn-secondary:hover { background-color: #38a169; }
        .btn-danger { background-color: #f56565; color: white; }
        .btn-danger:hover { background-color: #e53e3e; }
        .btn-group { display: flex; gap: 10px; margin-top: 15px; }
        .btn-group .btn { flex: 1; }
        .preview-area { border: 2px dashed #ddd; border-radius: 8px; padding: 20px; background-color: #fafafa; min-height: 400px; }
        .message { padding: 10px 15px; border-radius: 4px; margin-bottom: 15px; display: none; }
        .message.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .message.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .message.show { display: block; }
        .area-item { background-color: white; border: 1px solid #ddd; border-radius: 4px; padding: 10px; margin-bottom: 10px; cursor: move; }
        .area-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .area-item-title { font-weight: bold; color: #333; }
        .area-item-remove { color: #f56565; cursor: pointer; font-weight: bold; }
        .area-item-details { font-size: 12px; color: #666; }
        
        /* å¸ƒå±€ç½‘æ ¼æ ·å¼ */
        .layout-grid-container { background-color: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .layout-grid { display: grid; gap: 2px; background-color: #e0e0e0; padding: 2px; border-radius: 4px; position: relative; }
        .grid-cell { background-color: white; border: 1px solid #ddd; min-height: 30px; position: relative; cursor: pointer; }
        .grid-cell:hover { background-color: #f0f8ff; }
        .grid-cell.selected { background-color: #e3f2fd; border-color: #2196f3; }
        .grid-cell.occupied { background-color: #f5f5f5; }
        
        /* åˆ†åŒºæ ·å¼ */
        .partition { background-color: rgba(33, 150, 243, 0.2); border: 2px solid #2196f3; border-radius: 4px; position: absolute; z-index: 10; cursor: move; user-select: none; }
        .partition:hover { border-color: #1976d2; background-color: rgba(33, 150, 243, 0.3); }
        .partition.selected { border-color: #1565c0; background-color: rgba(33, 150, 243, 0.4; }
        .partition-label { position: absolute; top: 5px; left: 5px; background: #2196f3; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; }
        .resize-handle { position: absolute; width: 10px; height: 10px; background: #2196f3; border: 2px solid white; border-radius: 50%; cursor: nwse-resize; }
        .resize-handle.nw { top: -5px; left: -5px; cursor: nw-resize; }
        .resize-handle.ne { top: -5px; right: -5px; cursor: ne-resize; }
        .resize-handle.sw { bottom: -5px; left: -5px; cursor: sw-resize; }
        .resize-handle.se { bottom: -5px; right: -5px; cursor: se-resize; }
        
        /* æ­¥éª¤æ ·å¼ */
        .step-indicator { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .step { flex: 1; text-align: center; padding: 10px; border-radius: 4px; font-weight: bold; }
        .step.active { background-color: #667eea; color: white; }
        .step.completed { background-color: #48bb78; color: white; }
        .step.pending { background-color: #e0e0e0; color: #666; }
        
        /* åº“ä½è®¾ç½®æ ·å¼ */
        .rack-settings { background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 10px; }
        .rack-preview { background-color: white; border: 1px solid #ddd; border-radius: 4px; padding: 10px; margin-top: 10px; min-height: 100px; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ­ ä»“åº“å¸ƒå±€è®¾è®¡å™¨</h1>
            <p>è‡ªå®šä¹‰è®¾è®¡æ‚¨çš„ä»“åº“å¸ƒå±€é…ç½®</p>
        </div>
        
        <div class="main-content">
            <div class="control-panel">
                <div id="message" class="message"></div>
                
                <!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
                <div class="step-indicator">
                    <div class="step active" id="step1">1. å¸ƒå±€åˆ†åŒº</div>
                    <div class="step pending" id="step2">2. åº“ä½è®¾ç½®</div>
                </div>
                
                <!-- æ­¥éª¤1: å¸ƒå±€åˆ†åŒº -->
                <div id="step1Content">
                    <div class="section">
                        <div class="section-title">åŸºæœ¬ä¿¡æ¯</div>
                        <div class="form-group">
                            <label for="layoutName">å¸ƒå±€åç§°</label>
                            <input type="text" id="layoutName" value="AåŸºåœ°å¸ƒå±€" placeholder="è¾“å…¥å¸ƒå±€åç§°">
                        </div>
                        <div class="form-group">
                            <label for="baseData">åŸºåœ°æ•°æ®</label>
                            <select id="baseData" onchange="loadBaseData()">
                                <option value="demo">æ¼”ç¤ºæ•°æ®</option>
                                <option value="baseA">AåŸºåœ° (56åº“ä½)</option>
                                <option value="custom">è‡ªå®šä¹‰</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="section">
                        <div class="section-title">åº“ä½ç»Ÿè®¡</div>
                        <div id="rackStats" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
                                <div>ğŸ”§ åŠ å·¥ä½ï¼š<span id="processCount">4</span> ä¸ª</div>
                                <div>ğŸ“¦ å­˜å‚¨ä½ï¼š<span id="storageCount">26</span> ä¸ª</div>
                                <div>ğŸ”„ ä¸´æ—¶åŒºï¼š<span id="tempCount">1</span> ä¸ª</div>
                                <div>ğŸ—‘ï¸ æŠ¥åºŸåŒºï¼š<span id="wasteCount">1</span> ä¸ª</div>
                                <div>ğŸ“Š æ€»åº“ä½ï¼š<span id="totalCount">32</span> ä¸ª</div>
                                <div>ğŸ“ ç©ºä½™ä½ï¼š<span id="emptyCount">24</span> ä¸ª</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <div class="section-title">åº“ä½æ± </div>
                        <div class="form-group">
                            <label>åº“ä½ç±»å‹ç­›é€‰</label>
                            <select id="rackTypeFilter" onchange="filterRacks()">
                                <option value="all">å…¨éƒ¨åº“ä½</option>
                                <option value="process">åŠ å·¥ä½ (å•åº“ä½)</option>
                                <option value="storage">å­˜å‚¨ä½ (ABåŒåº“ä½)</option>
                                <option value="temp">ä¸´æ—¶åŒº</option>
                                <option value="waste">æŠ¥åºŸåŒº</option>
                            </select>
                        </div>
                        <div id="rackPool" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px; background: white;">
                            <div style="color: #999; text-align: center; padding: 20px;">åŠ è½½åŸºåœ°æ•°æ®åæ˜¾ç¤ºåº“ä½</div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <div class="section-title">å¸ƒå±€ç½‘æ ¼</div>
                        <div class="size-inputs">
                            <div class="form-group">
                                <label for="gridWidth">ç½‘æ ¼å®½åº¦</label>
                                <input type="number" id="gridWidth" value="12" min="6" max="20" onchange="createLayoutGrid()">
                            </div>
                            <div class="form-group">
                                <label for="gridHeight">ç½‘æ ¼é«˜åº¦</label>
                                <input type="number" id="gridHeight" value="8" min="4" max="15" onchange="createLayoutGrid()">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="showGrid" checked onchange="toggleGrid()"> æ˜¾ç¤ºç½‘æ ¼çº¿
                            </label>
                        </div>
                        <div class="form-group">
                            <label>æ‹–æ‹½æ¨¡å¼</label>
                            <div class="btn-group">
                                <button class="btn btn-primary" id="dragModePlace" onclick="setDragMode('place')">æ”¾ç½®åº“ä½</button>
                                <button class="btn btn-secondary" id="dragModeRemove" onclick="setDragMode('remove')">ç§»é™¤åº“ä½</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="nextStep()">ä¸‹ä¸€æ­¥ â†’ åŒºåŸŸè®¾ç½®</button>
                        <button class="btn btn-secondary" onclick="autoLayout()">æ™ºèƒ½å¸ƒå±€</button>
                        <button class="btn btn-danger" onclick="resetAll()">é‡ç½®</button>
                    </div>
                </div>
                
                <!-- æ­¥éª¤2: åŒºåŸŸè®¾ç½® -->
                <div id="step2Content" style="display: none;">
                    <div class="section">
                        <div class="section-title">å¸ƒå±€ç¡®è®¤ä¸ä¼˜åŒ–</div>
                        <div class="form-group">
                            <label>å½“å‰å¸ƒå±€ç»Ÿè®¡</label>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                <div id="layoutStats" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
                                    <div>ğŸ“¦ å·²æ”¾ç½®åº“ä½ï¼š<span id="placedRackCount">0</span> ä¸ª</div>
                                    <div>ğŸ“Š å¸ƒå±€åˆ©ç”¨ç‡ï¼š<span id="layoutUtilization">0</span>%</div>
                                    <div>ğŸ”§ åŠ å·¥ä½ï¼š<span id="placedProcessCount">0</span> ä¸ª</div>
                                    <div>ğŸ“¦ å­˜å‚¨ä½ï¼š<span id="placedStorageCount">0</span> ä¸ª</div>
                                    <div>ğŸ”„ ä¸´æ—¶åŒºï¼š<span id="placedTempCount">0</span> ä¸ª</div>
                                    <div>ğŸ—‘ï¸ æŠ¥åºŸåŒºï¼š<span id="placedWasteCount">0</span> ä¸ª</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>å¸ƒå±€å»ºè®®</label>
                            <div id="layoutSuggestions" style="background: #fff3cd; padding: 15px; border-radius: 8px; border: 1px solid #ffeaa7;">
                                <div style="color: #856404;">ğŸ“‹ å¸ƒå±€ä¼˜åŒ–å»ºè®®ï¼š</div>
                                <ul style="margin: 10px 0 0 20px; color: #856404; font-size: 14px;">
                                    <li>åŠ å·¥ä½å»ºè®®æ”¾ç½®åœ¨å·¦ä¾§ï¼Œä¾¿äºæ“ä½œ</li>
                                    <li>å­˜å‚¨ä½å»ºè®®é›†ä¸­æ”¾ç½®ï¼Œæé«˜ç©ºé—´åˆ©ç”¨ç‡</li>
                                    <li>ä¸´æ—¶åŒºå’ŒæŠ¥åºŸåŒºå»ºè®®æ”¾ç½®åœ¨è¾¹ç¼˜ä½ç½®</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <div class="section-title">å¸ƒå±€è°ƒæ•´</div>
                        <div class="form-group">
                            <label>å¿«é€Ÿæ“ä½œ</label>
                            <div class="btn-group">
                                <button class="btn btn-secondary" onclick="optimizeLayout()">ä¼˜åŒ–å¸ƒå±€</button>
                                <button class="btn btn-secondary" onclick="clearLayout()">æ¸…ç©ºå¸ƒå±€</button>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>åŒºåŸŸå‘½å</label>
                            <textarea id="areaNames" style="width: 100%; height: 80px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="ä¸ºä¸åŒåŒºåŸŸå‘½åï¼Œä¾‹å¦‚ï¼š&#10;å·¦ä¾§åŒºåŸŸï¼šåŠ å·¥ä½&#10;ä¸­å¤®åŒºåŸŸï¼šå­˜å‚¨åŒº&#10;åº•éƒ¨åŒºåŸŸï¼šä¸´æ—¶åŒº/æŠ¥åºŸåŒº"></textarea>
                        </div>
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="prevStep()">â† ä¸Šä¸€æ­¥</button>
                        <button class="btn btn-primary" onclick="generatePreview()">ç”Ÿæˆæœ€ç»ˆé¢„è§ˆ</button>
                        <button class="btn btn-primary" onclick="exportConfig()">å¯¼å‡ºé…ç½®</button>
                    </div>
                </div>
            </div>
            
            <div class="preview-panel">
                <h3 style="margin-bottom: 15px;">ğŸ“ å¸ƒå±€é¢„è§ˆ</h3>
                <div class="preview-area" id="previewArea">
                    <div style="text-align: center; color: #999; padding: 50px;">
                        <p>ğŸ¨ ç‚¹å‡»"ç”Ÿæˆé¢„è§ˆ"æŸ¥çœ‹æ‚¨çš„å¸ƒå±€è®¾è®¡</p>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <h4>é…ç½®JSON</h4>
                    <textarea id="configOutput" style="width: 100%; height: 200px; font-family: monospace; font-size: 12px; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" readonly placeholder="é…ç½®å°†åœ¨è¿™é‡Œæ˜¾ç¤º..."></textarea>
                    <div style="margin-top: 10px;">
                        <button class="btn btn-primary" onclick="copyConfig()">å¤åˆ¶é…ç½®</button>
                        <button class="btn btn-secondary" onclick="downloadConfig()">ä¸‹è½½é…ç½®</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let partitions = [];
        let currentStep = 1;
        let currentConfig = {};
        let selectedPartition = null;
        let isCreatingPartition = false;
        let partitionStart = null;
        let isDragging = false;
        let isResizing = false;
        let dragMode = 'place'; // 'place' or 'remove'
        let rackPool = []; // æ‰€æœ‰å¯ç”¨åº“ä½
        let placedRacks = []; // å·²æ”¾ç½®çš„åº“ä½
        let baseData = {}; // åŸºåœ°æ•°æ®

        // åŸºåœ°æ•°æ®
        const baseDatabase = {
            baseA: {
                name: "AåŸºåœ°",
                totalRacks: 56,
                racks: [
                    // åŠ å·¥ä½ 1-4 (å•åº“ä½)
                    { id: "001", type: "process", name: "åŠ å·¥ä½-1", category: "single" },
                    { id: "002", type: "process", name: "åŠ å·¥ä½-2", category: "single" },
                    { id: "003", type: "process", name: "åŠ å·¥ä½-3", category: "single" },
                    { id: "004", type: "process", name: "åŠ å·¥ä½-4", category: "single" },
                    // å­˜å‚¨ä½ 5-30 (ABåŒåº“ä½)
                    { id: "005", type: "storage", name: "å­˜å‚¨ä½-5", category: "pair", pairId: "005A,005B" },
                    { id: "006", type: "storage", name: "å­˜å‚¨ä½-6", category: "pair", pairId: "006A,006B" },
                    { id: "007", type: "storage", name: "å­˜å‚¨ä½-7", category: "pair", pairId: "007A,007B" },
                    { id: "008", type: "storage", name: "å­˜å‚¨ä½-8", category: "pair", pairId: "008A,008B" },
                    { id: "009", type: "storage", name: "å­˜å‚¨ä½-9", category: "pair", pairId: "009A,009B" },
                    { id: "010", type: "storage", name: "å­˜å‚¨ä½-10", category: "pair", pairId: "010A,010B" },
                    { id: "011", type: "storage", name: "å­˜å‚¨ä½-11", category: "pair", pairId: "011A,011B" },
                    { id: "012", type: "storage", name: "å­˜å‚¨ä½-12", category: "pair", pairId: "012A,012B" },
                    { id: "013", type: "storage", name: "å­˜å‚¨ä½-13", category: "pair", pairId: "013A,013B" },
                    { id: "014", type: "storage", name: "å­˜å‚¨ä½-14", category: "pair", pairId: "014A,014B" },
                    { id: "015", type: "storage", name: "å­˜å‚¨ä½-15", category: "pair", pairId: "015A,015B" },
                    { id: "016", type: "storage", name: "å­˜å‚¨ä½-16", category: "pair", pairId: "016A,016B" },
                    { id: "017", type: "storage", name: "å­˜å‚¨ä½-17", category: "pair", pairId: "017A,017B" },
                    { id: "018", type: "storage", name: "å­˜å‚¨ä½-18", category: "pair", pairId: "018A,018B" },
                    { id: "019", type: "storage", name: "å­˜å‚¨ä½-19", category: "pair", pairId: "019A,019B" },
                    { id: "020", type: "storage", name: "å­˜å‚¨ä½-20", category: "pair", pairId: "020A,020B" },
                    { id: "021", type: "storage", name: "å­˜å‚¨ä½-21", category: "pair", pairId: "021A,021B" },
                    { id: "022", type: "storage", name: "å­˜å‚¨ä½-22", category: "pair", pairId: "022A,022B" },
                    { id: "023", type: "storage", name: "å­˜å‚¨ä½-23", category: "pair", pairId: "023A,023B" },
                    { id: "024", type: "storage", name: "å­˜å‚¨ä½-24", category: "pair", pairId: "024A,024B" },
                    { id: "025", type: "storage", name: "å­˜å‚¨ä½-25", category: "pair", pairId: "025A,025B" },
                    { id: "026", type: "storage", name: "å­˜å‚¨ä½-26", category: "pair", pairId: "026A,026B" },
                    { id: "027", type: "storage", name: "å­˜å‚¨ä½-27", category: "pair", pairId: "027A,027B" },
                    { id: "028", type: "storage", name: "å­˜å‚¨ä½-28", category: "pair", pairId: "028A,028B" },
                    { id: "029", type: "storage", name: "å­˜å‚¨ä½-29", category: "pair", pairId: "029A,029B" },
                    { id: "030", type: "storage", name: "å­˜å‚¨ä½-30", category: "pair", pairId: "030A,030B" },
                    // ä¸´æ—¶åŒº
                    { id: "TEMP-01", type: "temp", name: "ä¸´æ—¶åŒº-1", category: "area", visible: false },
                    // æŠ¥åºŸåŒº
                    { id: "WASTE-01", type: "waste", name: "æŠ¥åºŸåŒº-1", category: "area" }
                ]
            }
        };

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadDefaultConfig();
            loadBaseData();
            createLayoutGrid();
        });

        // åŠ è½½é»˜è®¤é…ç½®
        function loadDefaultConfig() {
            currentConfig = {
                layoutName: "AåŸºåœ°å¸ƒå±€",
                version: "1.0",
                created: new Date().toISOString().split('T')[0],
                dimensions: { totalWidth: 12, totalHeight: 8 },
                racks: [],
                areas: []
            };
        }

        // åŠ è½½åŸºåœ°æ•°æ®
        function loadBaseData() {
            const baseSelect = document.getElementById('baseData').value;
            
            if (baseSelect === 'demo') {
                // æ¼”ç¤ºæ•°æ®
                rackPool = generateDemoRacks();
                updateRackStats();
            } else if (baseSelect === 'baseA') {
                // AåŸºåœ°æ•°æ®
                baseData = baseDatabase.baseA;
                rackPool = [...baseData.racks];
                updateRackStats();
                showMessage('AåŸºåœ°æ•°æ®åŠ è½½æˆåŠŸ', 'success');
            } else {
                // è‡ªå®šä¹‰
                rackPool = [];
                showMessage('è¯·æ‰‹åŠ¨æ·»åŠ åº“ä½æ•°æ®', 'success');
            }
            
            updateRackPool();
        }

        // ç”Ÿæˆæ¼”ç¤ºæ•°æ®
        function generateDemoRacks() {
            const demoRacks = [];
            for (let i = 1; i <= 8; i++) {
                demoRacks.push({
                    id: String(i).padStart(3, '0'),
                    type: i <= 2 ? 'process' : 'storage',
                    name: i <= 2 ? `åŠ å·¥ä½-${i}` : `å­˜å‚¨ä½-${i}`,
                    category: i <= 2 ? 'single' : 'pair',
                    pairId: i > 2 ? `${String(i).padStart(3, '0')}A,${String(i).padStart(3, '0')}B` : null
                });
            }
            demoRacks.push({ id: "TEMP-01", type: "temp", name: "ä¸´æ—¶åŒº-1", category: "area" });
            demoRacks.push({ id: "WASTE-01", type: "waste", name: "æŠ¥åºŸåŒº-1", category: "area" });
            return demoRacks;
        }

        // æ›´æ–°åº“ä½ç»Ÿè®¡
        function updateRackStats() {
            const stats = {
                process: rackPool.filter(r => r.type === 'process').length,
                storage: rackPool.filter(r => r.type === 'storage').length,
                temp: rackPool.filter(r => r.type === 'temp').length,
                waste: rackPool.filter(r => r.type === 'waste').length,
                total: rackPool.length,
                empty: rackPool.filter(r => !placedRacks.find(p => p.id === r.id)).length
            };
            
            document.getElementById('processCount').textContent = stats.process;
            document.getElementById('storageCount').textContent = stats.storage;
            document.getElementById('tempCount').textContent = stats.temp;
            document.getElementById('wasteCount').textContent = stats.waste;
            document.getElementById('totalCount').textContent = stats.total;
            document.getElementById('emptyCount').textContent = stats.empty;
        }

        // æ›´æ–°åº“ä½æ± æ˜¾ç¤º
        function updateRackPool(filter = 'all') {
            const poolDiv = document.getElementById('rackPool');
            let filteredRacks = rackPool;
            
            if (filter !== 'all') {
                filteredRacks = rackPool.filter(rack => rack.type === filter);
            }
            
            let html = '';
            filteredRacks.forEach(rack => {
                const isPlaced = placedRacks.find(p => p.id === rack.id);
                const typeColors = {
                    'process': '#ff9800',
                    'storage': '#2196f3', 
                    'temp': '#9c27b0',
                    'waste': '#f44336'
                };
                const typeIcons = {
                    'process': 'ğŸ”§',
                    'storage': 'ğŸ“¦',
                    'temp': 'ğŸ”„',
                    'waste': 'ğŸ—‘ï¸'
                };
                
                html += '<div class="area-item" style="cursor: grab; opacity: ' + (isPlaced ? '0.5' : '1') + '; border-left: 4px solid ' + typeColors[rack.type] + ';" onclick="selectRackFromPool(\'' + rack.id + '\')" draggable="true" ondragstart="dragRack(event, \'' + rack.id + '\')">';
                html += '<div class="area-item-header"><span class="area-item-title">' + typeIcons[rack.type] + ' ' + rack.name + '</span><span style="font-size: 12px; color: ' + (isPlaced ? '#999' : '#666') + ';">' + (isPlaced ? 'å·²æ”¾ç½®' : rack.id) + '</span></div>';
                html += '<div class="area-item-details">ç±»å‹: ' + rack.category + ' | ' + (rack.pairId || 'å•åº“ä½') + '</div>';
                html += '</div>';
            });
            
            if (filteredRacks.length === 0) {
                html = '<div style="text-align: center; color: #999; padding: 20px;">è¯¥ç±»å‹æš‚æ— åº“ä½</div>';
            }
            
            poolDiv.innerHTML = html;
        }

        // ç­›é€‰åº“ä½
        function filterRacks() {
            const filter = document.getElementById('rackTypeFilter').value;
            updateRackPool(filter);
        }

        // ä»åº“ä½æ± é€‰æ‹©åº“ä½
        function selectRackFromPool(rackId) {
            const rack = rackPool.find(r => r.id === rackId);
            if (rack && !placedRacks.find(p => p.id === rackId)) {
                // è®¾ç½®æ‹–æ‹½æ¨¡å¼
                setDragMode('place');
                showMessage('å·²é€‰æ‹©åº“ä½: ' + rack.name + 'ï¼Œç‚¹å‡»ç½‘æ ¼æ”¾ç½®', 'success');
            } else if (placedRacks.find(p => p.id === rackId)) {
                showMessage('è¯¥åº“ä½å·²æ”¾ç½®', 'error');
            }
        }

        // è®¾ç½®æ‹–æ‹½æ¨¡å¼
        function setDragMode(mode) {
            dragMode = mode;
            document.getElementById('dragModePlace').className = mode === 'place' ? 'btn btn-primary' : 'btn btn-secondary';
            document.getElementById('dragModeRemove').className = mode === 'remove' ? 'btn btn-primary' : 'btn btn-secondary';
            showMessage(mode === 'place' ? 'æ”¾ç½®æ¨¡å¼ï¼šç‚¹å‡»ç½‘æ ¼æ”¾ç½®åº“ä½' : 'ç§»é™¤æ¨¡å¼ï¼šç‚¹å‡»ç½‘æ ¼ç§»é™¤åº“ä½', 'success');
        }

        // æ‹–æ‹½åº“ä½
        function dragRack(event, rackId) {
            event.dataTransfer.setData('rackId', rackId);
        }

        // æ™ºèƒ½å¸ƒå±€
        function autoLayout() {
            if (rackPool.length === 0) {
                showMessage('è¯·å…ˆåŠ è½½åŸºåœ°æ•°æ®', 'error');
                return;
            }
            
            // æ¸…ç©ºç°æœ‰å¸ƒå±€
            placedRacks = [];
            
            // æŒ‰ç±»å‹åˆ†ç»„å¸ƒå±€
            const width = currentConfig.dimensions.totalWidth;
            const height = currentConfig.dimensions.totalHeight;
            let currentPos = { x: 0, y: 0 };
            
            // 1. æ”¾ç½®åŠ å·¥ä½ï¼ˆä¼˜å…ˆå·¦ä¾§ï¼‰
            const processRacks = rackPool.filter(r => r.type === 'process');
            processRacks.forEach((rack, index) => {
                if (currentPos.x >= width - 1) {
                    currentPos.x = 0;
                    currentPos.y += 2;
                }
                if (currentPos.y < height) {
                    placedRacks.push({
                        ...rack,
                        position: { x: currentPos.x, y: currentPos.y },
                        size: { width: 1, height: 1 }
                    });
                    currentPos.x += 1;
                }
            });
            
            // 2. æ”¾ç½®å­˜å‚¨ä½ï¼ˆABåŒåº“ä½ï¼‰
            currentPos.x = 0;
            currentPos.y += 1;
            const storageRacks = rackPool.filter(r => r.type === 'storage');
            storageRacks.forEach((rack, index) => {
                if (currentPos.x >= width - 2) {
                    currentPos.x = 0;
                    currentPos.y += 2;
                }
                if (currentPos.y < height) {
                    placedRacks.push({
                        ...rack,
                        position: { x: currentPos.x, y: currentPos.y },
                        size: { width: 2, height: 1 }
                    });
                    currentPos.x += 2;
                }
            });
            
            // 3. æ”¾ç½®ä¸´æ—¶åŒºå’ŒæŠ¥åºŸåŒºï¼ˆåº•éƒ¨ï¼‰
            const specialRacks = rackPool.filter(r => r.type === 'temp' || r.type === 'waste');
            currentPos.x = 0;
            currentPos.y = height - 1;
            specialRacks.forEach(rack => {
                if (currentPos.x < width - 3) {
                    placedRacks.push({
                        ...rack,
                        position: { x: currentPos.x, y: currentPos.y },
                        size: { width: 3, height: 1 }
                    });
                    currentPos.x += 3;
                }
            });
            
            renderPlacedRacks();
            updateRackStats();
            showMessage('æ™ºèƒ½å¸ƒå±€å®Œæˆ', 'success');
        }

        // åˆ›å»ºå¸ƒå±€ç½‘æ ¼
        function createLayoutGrid() {
            const width = parseInt(document.getElementById('gridWidth').value);
            const height = parseInt(document.getElementById('gridHeight').value);
            const previewArea = document.getElementById('previewArea');
            
            currentConfig.dimensions = { totalWidth: width, totalHeight: height };
            
            let html = '<div class="layout-grid-container">';
            html += '<h3>å¸ƒå±€è®¾è®¡ç½‘æ ¼ (' + dragMode === 'place' ? 'ç‚¹å‡»æ”¾ç½®åº“ä½' : 'ç‚¹å‡»ç§»é™¤åº“ä½' + ')</h3>';
            html += '<div class="layout-grid" id="layoutGrid" style="grid-template-columns: repeat(' + width + ', 40px); grid-template-rows: repeat(' + height + ', 40px);" ondrop="dropRack(event)" ondragover="allowDrop(event)">';
            
            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    html += '<div class="grid-cell" data-x="' + x + '" data-y="' + y + '" onclick="handleGridClick(' + x + ', ' + y + ')" ondragover="allowDrop(event)" ondrop="dropRackOnCell(event, ' + x + ', ' + y + ')"></div>';
                }
            }
            
            html += '</div>';
            html += '</div>';
            
            previewArea.innerHTML = html;
            renderPlacedRacks();
            
            // æ›´æ–°é…ç½®
            currentConfig.dimensions = { totalWidth: width, totalHeight: height };
        }

        // å¤„ç†ç½‘æ ¼ç‚¹å‡»
        function handleGridClick(x, y) {
            if (dragMode === 'place') {
                // æ”¾ç½®æ¨¡å¼ - é€‰æ‹©è¦æ”¾ç½®çš„åº“ä½
                const unplacedRack = rackPool.find(rack => !placedRacks.find(p => p.id === rack.id));
                if (unplacedRack) {
                    placeRack(unplacedRack, x, y);
                } else {
                    showMessage('æ²¡æœ‰å¯æ”¾ç½®çš„åº“ä½', 'error');
                }
            } else if (dragMode === 'remove') {
                // ç§»é™¤æ¨¡å¼ - ç§»é™¤è¯¥ä½ç½®çš„åº“ä½
                const rackIndex = placedRacks.findIndex(r => 
                    x >= r.position.x && x < r.position.x + r.size.width &&
                    y >= r.position.y && y < r.position.y + r.size.height
                );
                if (rackIndex !== -1) {
                    removeRack(rackIndex);
                }
            }
        }

        // æ”¾ç½®åº“ä½
        function placeRack(rack, x, y) {
            // æ£€æŸ¥ä½ç½®æ˜¯å¦å¯ç”¨
            const isOccupied = placedRacks.some(r => {
                return !(x >= r.position.x + r.size.width || 
                        x + rack.size.width <= r.position.x ||
                        y >= r.position.y + r.size.height ||
                        y + rack.size.height <= r.position.y);
            });
            
            if (isOccupied) {
                showMessage('è¯¥ä½ç½®å·²è¢«å ç”¨', 'error');
                return;
            }
            
            // æ£€æŸ¥è¾¹ç•Œ
            if (x + rack.size.width > currentConfig.dimensions.totalWidth || 
                y + rack.size.height > currentConfig.dimensions.totalHeight) {
                showMessage('è¶…å‡ºå¸ƒå±€è¾¹ç•Œ', 'error');
                return;
            }
            
            placedRacks.push({
                ...rack,
                position: { x: x, y: y },
                size: rack.size || { width: rack.category === 'pair' ? 2 : 1, height: 1 }
            });
            
            renderPlacedRacks();
            updateRackStats();
            updateRackPool(document.getElementById('rackTypeFilter').value);
            showMessage('åº“ä½æ”¾ç½®æˆåŠŸ: ' + rack.name, 'success');
        }

        // ç§»é™¤åº“ä½
        function removeRack(index) {
            const rack = placedRacks[index];
            placedRacks.splice(index, 1);
            renderPlacedRacks();
            updateRackStats();
            updateRackPool(document.getElementById('rackTypeFilter').value);
            showMessage('åº“ä½ç§»é™¤æˆåŠŸ: ' + rack.name, 'success');
        }

        // æ¸²æŸ“å·²æ”¾ç½®çš„åº“ä½
        function renderPlacedRacks() {
            const grid = document.getElementById('layoutGrid');
            if (!grid) return;
            
            // æ¸…é™¤ç°æœ‰åº“ä½æ˜¾ç¤º
            const existingRacks = grid.querySelectorAll('.placed-rack');
            existingRacks.forEach(r => r.remove());
            
            const cellSize = 42; // 40px + 2px gap
            
            placedRacks.forEach(rack => {
                const div = document.createElement('div');
                div.className = 'placed-rack';
                div.id = 'placed-' + rack.id;
                
                // æ ¹æ®åº“ä½ç±»å‹è®¾ç½®æ ·å¼
                const typeColors = {
                    'process': '#ff9800',
                    'storage': '#2196f3',
                    'temp': '#9c27b0',
                    'waste': '#f44336'
                };
                
                const color = typeColors[rack.type] || '#666';
                const width = rack.size.width * cellSize - 4;
                const height = cellSize - 4;
                
                div.style.cssText = `
                    position: absolute;
                    left: ${rack.position.x * cellSize}px;
                    top: ${rack.position.y * cellSize}px;
                    width: ${width}px;
                    height: ${height}px;
                    background-color: ${color}20;
                    border: 2px solid ${color};
                    border-radius: 4px;
                    z-index: 10;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 12px;
                    font-weight: bold;
                    color: ${color};
                `;
                
                div.textContent = rack.id;
                div.title = rack.name;
                div.onclick = (e) => {
                    e.stopPropagation();
                    if (dragMode === 'remove') {
                        const index = placedRacks.findIndex(r => r.id === rack.id);
                        removeRack(index);
                    }
                };
                
                grid.appendChild(div);
            });
        }

        // æ‹–æ‹½ç›¸å…³å‡½æ•°
        function allowDrop(event) {
            event.preventDefault();
        }

        function dropRack(event) {
            event.preventDefault();
            // å¤„ç†æ‹–æ‹½åˆ°ç½‘æ ¼å¤–çš„æƒ…å†µ
        }

        function dropRackOnCell(event, x, y) {
            event.preventDefault();
            const rackId = event.dataTransfer.getData('rackId');
            const rack = rackPool.find(r => r.id === rackId);
            
            if (rack && !placedRacks.find(p => p.id === rackId)) {
                placeRack(rack, x, y);
            }
        }

        // å¼€å§‹åˆ›å»ºåˆ†åŒº
        function startCreatingPartition() {
            if (partitions.length >= 6) {
                showMessage('æœ€å¤šæ”¯æŒ6ä¸ªåˆ†åŒº', 'error');
                return;
            }
            isCreatingPartition = true;
            showMessage('åœ¨ç½‘æ ¼ä¸Šæ‹–æ‹½åˆ›å»ºåˆ†åŒº', 'success');
        }

        // å¼€å§‹åˆ†åŒºæ‹–æ‹½
        function startPartitionDrag(event, x, y) {
            if (!isCreatingPartition) return;
            
            event.preventDefault();
            partitionStart = { x: x, y: y };
            isDragging = true;
            
            document.addEventListener('mousemove', handlePartitionDrag);
            document.addEventListener('mouseup', endPartitionDrag);
        }

        // å¤„ç†åˆ†åŒºæ‹–æ‹½
        function handlePartitionDrag(event) {
            if (!isDragging || !partitionStart) return;
            
            const grid = document.getElementById('layoutGrid');
            const rect = grid.getBoundingClientRect();
            const cellSize = 32; // 30px + 2px gap
            
            const endX = Math.min(Math.max(0, Math.floor((event.clientX - rect.left) / cellSize)), currentConfig.dimensions.totalWidth - 1);
            const endY = Math.min(Math.max(0, Math.floor((event.clientY - rect.top) / cellSize)), currentConfig.dimensions.totalHeight - 1);
            
            // æ˜¾ç¤ºé¢„è§ˆ
            updatePartitionPreview(partitionStart.x, partitionStart.y, endX, endY);
        }

        // ç»“æŸåˆ†åŒºæ‹–æ‹½
        function endPartitionDrag(event) {
            if (!isDragging || !partitionStart) return;
            
            const grid = document.getElementById('layoutGrid');
            const rect = grid.getBoundingClientRect();
            const cellSize = 32;
            
            const endX = Math.min(Math.max(0, Math.floor((event.clientX - rect.left) / cellSize)), currentConfig.dimensions.totalWidth - 1);
            const endY = Math.min(Math.max(0, Math.floor((event.clientY - rect.top) / cellSize)), currentConfig.dimensions.totalHeight - 1);
            
            // åˆ›å»ºåˆ†åŒº
            createPartition(partitionStart.x, partitionStart.y, endX, endY);
            
            // æ¸…ç†
            isDragging = false;
            partitionStart = null;
            isCreatingPartition = false;
            document.removeEventListener('mousemove', handlePartitionDrag);
            document.removeEventListener('mouseup', endPartitionDrag);
            
            // æ¸…é™¤é¢„è§ˆ
            clearPartitionPreview();
        }

        // åˆ›å»ºåˆ†åŒº
        function createPartition(startX, startY, endX, endY) {
            const x = Math.min(startX, endX);
            const y = Math.min(startY, endY);
            const width = Math.abs(endX - startX) + 1;
            const height = Math.abs(endY - startY) + 1;
            
            if (width < 1 || height < 1) {
                showMessage('åˆ†åŒºå¤ªå°ï¼Œè¯·é‡æ–°æ‹–æ‹½', 'error');
                return;
            }
            
            const partition = {
                id: 'partition_' + Date.now(),
                name: 'åˆ†åŒº' + (partitions.length + 1),
                position: { x: x, y: y },
                size: { width: width, height: height },
                rackSettings: {
                    arrangement: 'horizontal',
                    startNum: 1,
                    prefix: ''
                }
            };
            
            partitions.push(partition);
            renderPartitions();
            updatePartitionsList();
            showMessage('åˆ†åŒºåˆ›å»ºæˆåŠŸ', 'success');
        }

        // æ¸²æŸ“åˆ†åŒº
        function renderPartitions() {
            const grid = document.getElementById('layoutGrid');
            if (!grid) return;
            
            // æ¸…é™¤ç°æœ‰åˆ†åŒº
            const existingPartitions = grid.querySelectorAll('.partition');
            existingPartitions.forEach(p => p.remove());
            
            const cellSize = 32; // 30px + 2px gap
            
            partitions.forEach((partition, index) => {
                const div = document.createElement('div');
                div.className = 'partition';
                div.id = partition.id;
                div.style.left = (partition.position.x * cellSize) + 'px';
                div.style.top = (partition.position.y * cellSize) + 'px';
                div.style.width = (partition.size.width * cellSize - 4) + 'px';
                div.style.height = (partition.size.height * cellSize - 4) + 'px';
                
                // æ·»åŠ æ ‡ç­¾
                const label = document.createElement('div');
                label.className = 'partition-label';
                label.textContent = partition.name;
                div.appendChild(label);
                
                // æ·»åŠ è°ƒæ•´å¤§å°æ‰‹æŸ„
                ['nw', 'ne', 'sw', 'se'].forEach(pos => {
                    const handle = document.createElement('div');
                    handle.className = 'resize-handle ' + pos;
                    handle.onmousedown = (e) => startResize(e, index, pos);
                    div.appendChild(handle);
                });
                
                // æ·»åŠ ç‚¹å‡»é€‰æ‹©
                div.onclick = (e) => {
                    if (!e.target.classList.contains('resize-handle')) {
                        selectPartition(index);
                    }
                };
                
                grid.appendChild(div);
            });
        }

        // é€‰æ‹©åˆ†åŒº
        function selectPartition(index) {
            // æ¸…é™¤ä¹‹å‰çš„é€‰æ‹©
            document.querySelectorAll('.partition').forEach(p => p.classList.remove('selected'));
            
            // é€‰æ‹©å½“å‰åˆ†åŒº
            const partition = document.getElementById(partitions[index].id);
            if (partition) {
                partition.classList.add('selected');
                selectedPartition = index;
            }
        }

        // åˆ é™¤é€‰ä¸­çš„åˆ†åŒº
        function deleteSelectedPartition() {
            if (selectedPartition === null) {
                showMessage('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„åˆ†åŒº', 'error');
                return;
            }
            
            partitions.splice(selectedPartition, 1);
            selectedPartition = null;
            renderPartitions();
            updatePartitionsList();
            showMessage('åˆ†åŒºå·²åˆ é™¤', 'success');
        }

        // æ›´æ–°åˆ†åŒºåˆ—è¡¨
        function updatePartitionsList() {
            const list = document.getElementById('partitionsList');
            const count = document.getElementById('partitionCount');
            
            count.textContent = partitions.length;
            list.innerHTML = '';
            
            partitions.forEach((partition, index) => {
                const item = document.createElement('div');
                item.className = 'area-item';
                item.style.cursor = 'pointer';
                item.innerHTML = '<div class="area-item-header"><span class="area-item-title">' + partition.name + '</span></div><div class="area-item-details">ä½ç½®: (' + partition.position.x + ', ' + partition.position.y + ') | å°ºå¯¸: ' + partition.size.width + 'Ã—' + partition.size.height + '</div>';
                item.onclick = () => selectPartition(index);
                list.appendChild(item);
            });
        }

        // æ­¥éª¤æ§åˆ¶
        function nextStep() {
            if (currentStep === 1 && placedRacks.length === 0) {
                showMessage('è¯·è‡³å°‘æ”¾ç½®ä¸€ä¸ªåº“ä½', 'error');
                return;
            }
            
            currentStep = 2;
            document.getElementById('step1').classList.remove('active');
            document.getElementById('step1').classList.add('completed');
            document.getElementById('step2').classList.remove('pending');
            document.getElementById('step2').classList.add('active');
            
            document.getElementById('step1Content').style.display = 'none';
            document.getElementById('step2Content').style.display = 'block';
            
            updateLayoutStats();
            showMessage('è¿›å…¥å¸ƒå±€ç¡®è®¤é˜¶æ®µ', 'success');
        }

        function prevStep() {
            currentStep = 1;
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step2').classList.add('pending');
            document.getElementById('step1').classList.remove('completed');
            document.getElementById('step1').classList.add('active');
            
            document.getElementById('step2Content').style.display = 'none';
            document.getElementById('step1Content').style.display = 'block';
        }

        // æ›´æ–°å¸ƒå±€ç»Ÿè®¡
        function updateLayoutStats() {
            const totalCells = currentConfig.dimensions.totalWidth * currentConfig.dimensions.totalHeight;
            const usedCells = placedRacks.reduce((sum, rack) => sum + (rack.size.width * rack.size.height), 0);
            const utilization = Math.round((usedCells / totalCells) * 100);
            
            const stats = {
                total: placedRacks.length,
                process: placedRacks.filter(r => r.type === 'process').length,
                storage: placedRacks.filter(r => r.type === 'storage').length,
                temp: placedRacks.filter(r => r.type === 'temp').length,
                waste: placedRacks.filter(r => r.type === 'waste').length
            };
            
            document.getElementById('placedRackCount').textContent = stats.total;
            document.getElementById('layoutUtilization').textContent = utilization;
            document.getElementById('placedProcessCount').textContent = stats.process;
            document.getElementById('placedStorageCount').textContent = stats.storage;
            document.getElementById('placedTempCount').textContent = stats.temp;
            document.getElementById('placedWasteCount').textContent = stats.waste;
        }

        // ä¼˜åŒ–å¸ƒå±€
        function optimizeLayout() {
            if (placedRacks.length === 0) {
                showMessage('è¯·å…ˆæ”¾ç½®ä¸€äº›åº“ä½', 'error');
                return;
            }
            
            // ç®€å•çš„ä¼˜åŒ–ç®—æ³•ï¼šæŒ‰ç±»å‹é‡æ–°æ’åˆ—
            const width = currentConfig.dimensions.totalWidth;
            const optimizedRacks = [];
            let currentPos = { x: 0, y: 0 };
            
            // æŒ‰ä¼˜å…ˆçº§æ’åºï¼šprocess > storage > temp > waste
            const sortedRacks = [...placedRacks].sort((a, b) => {
                const priority = { 'process': 1, 'storage': 2, 'temp': 3, 'waste': 4 };
                return priority[a.type] - priority[b.type];
            });
            
            sortedRacks.forEach(rack => {
                if (currentPos.x + rack.size.width > width) {
                    currentPos.x = 0;
                    currentPos.y += 2;
                }
                
                optimizedRacks.push({
                    ...rack,
                    position: { x: currentPos.x, y: currentPos.y }
                });
                
                currentPos.x += rack.size.width;
            });
            
            placedRacks = optimizedRacks;
            renderPlacedRacks();
            updateLayoutStats();
            showMessage('å¸ƒå±€ä¼˜åŒ–å®Œæˆ', 'success');
        }

        // æ¸…ç©ºå¸ƒå±€
        function clearLayout() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºå½“å‰å¸ƒå±€å—ï¼Ÿ')) {
                placedRacks = [];
                renderPlacedRacks();
                updateRackStats();
                updateRackPool(document.getElementById('rackTypeFilter').value);
                showMessage('å¸ƒå±€å·²æ¸…ç©º', 'success');
            }
        }

        // ç”Ÿæˆé¢„è§ˆ - åŸºäºå®é™…åº“ä½å¸ƒå±€
        function generatePreview() {
            updateConfig();
            const previewArea = document.getElementById('previewArea');
            const areaNames = document.getElementById('areaNames').value;
            
            let html = '<div style="background-color: white; padding: 20px; border-radius: 8px;">';
            html += '<h3 style="margin-bottom: 15px; color: #333;">ğŸ“Š æœ€ç»ˆå¸ƒå±€é¢„è§ˆ</h3>';
            
            // åˆ›å»ºåº“ä½å¸ƒå±€
            html += createRackLayoutHtml();
            html += '</div>';
            
            // æ·»åŠ é…ç½®æ˜¾ç¤ºåŒºåŸŸ
            html += '<div style="margin-top: 30px; background-color: #f8f9fa; padding: 15px; border-radius: 8px;">';
            html += '<h4 style="margin-bottom: 10px; color: #333;">ğŸ“ å¸ƒå±€é…ç½®ä¿¡æ¯</h4>';
            
            if (areaNames) {
                html += '<div style="background-color: #17a2b8; color: white; padding: 10px; border-radius: 4px; font-size: 14px; margin-bottom: 10px;"><strong>åŒºåŸŸå‘½åï¼š</strong><br><pre style="white-space: pre-wrap; margin: 5px 0;">' + areaNames + '</pre></div>';
            }
            
            // æŒ‰ç±»å‹ç»Ÿè®¡
            const typeGroups = {};
            placedRacks.forEach(rack => {
                if (!typeGroups[rack.type]) {
                    typeGroups[rack.type] = [];
                }
                typeGroups[rack.type].push(rack);
            });
            
            const typeNames = {
                'process': 'ğŸ”§ åŠ å·¥ä½',
                'storage': 'ğŸ“¦ å­˜å‚¨ä½', 
                'temp': 'ğŸ”„ ä¸´æ—¶åŒº',
                'waste': 'ğŸ—‘ï¸ æŠ¥åºŸåŒº'
            };
            
            Object.keys(typeGroups).forEach(type => {
                html += '<div style="background-color: #2196f3; color: white; padding: 10px; border-radius: 4px; font-size: 14px; margin-bottom: 10px;"><strong>' + typeNames[type] + '</strong><br>';
                typeGroups[type].forEach(rack => {
                    html += rack.name + ' (ä½ç½®: ' + rack.position.x + ',' + rack.position.y + ') | ';
                });
                html = html.slice(0, -3); // ç§»é™¤æœ€åçš„ " | "
                html += '</div>';
            });
            
            html += '</div>';
            
            previewArea.innerHTML = html;
            document.getElementById('configOutput').value = JSON.stringify(currentConfig, null, 2);
            showMessage('æœ€ç»ˆé¢„è§ˆç”ŸæˆæˆåŠŸ', 'success');
        }

        // åˆ›å»ºåº“ä½å¸ƒå±€HTML
        function createRackLayoutHtml() {
            let html = '<div style="display: grid; grid-template-columns: repeat(' + currentConfig.dimensions.totalWidth + ', 50px); grid-template-rows: repeat(' + currentConfig.dimensions.totalHeight + ', 50px); gap: 5px; background-color: #f0f0f0; padding: 20px; border-radius: 8px;">';
            
            // åˆ›å»ºç©ºçš„ç½‘æ ¼
            const grid = Array(currentConfig.dimensions.totalHeight).fill(null).map(() => 
                Array(currentConfig.dimensions.totalWidth).fill(null)
            );
            
            // å¡«å……å·²æ”¾ç½®çš„åº“ä½
            placedRacks.forEach(rack => {
                for (let y = 0; y < rack.size.height; y++) {
                    for (let x = 0; x < rack.size.width; x++) {
                        const gridX = rack.position.x + x;
                        const gridY = rack.position.y + y;
                        if (gridX < currentConfig.dimensions.totalWidth && gridY < currentConfig.dimensions.totalHeight) {
                            grid[gridY][gridX] = { ...rack, cellX: x, cellY: y };
                        }
                    }
                }
            });
            
            // æ¸²æŸ“ç½‘æ ¼
            for (let y = 0; y < currentConfig.dimensions.totalHeight; y++) {
                for (let x = 0; x < currentConfig.dimensions.totalWidth; x++) {
                    const cell = grid[y][x];
                    const typeColors = {
                        'process': '#ff9800',
                        'storage': '#2196f3',
                        'temp': '#9c27b0', 
                        'waste': '#f44336'
                    };
                    
                    if (cell) {
                        const color = typeColors[cell.type] || '#666';
                        let content = cell.id;
                        
                        // å¯¹äºåŒåº“ä½ï¼Œæ˜¾ç¤ºA/B
                        if (cell.category === 'pair' && cell.pairId) {
                            const pairIds = cell.pairId.split(',');
                            content = pairIds[cell.cellX] || cell.id;
                        }
                        
                        html += '<div style="background-color: ' + color + '20; border: 2px solid ' + color + '; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold; color: ' + color + '; cursor: pointer;" title="' + cell.name + '">' + content + '</div>';
                    } else {
                        html += '<div style="background-color: white; border: 1px dashed #ddd; border-radius: 4px;"></div>';
                    }
                }
            }
            
            html += '</div>';
            return html;
        }

        // åˆ›å»ºåˆ†åŒºHTML - åŸºäºæ–°çš„åˆ†åŒºç³»ç»Ÿ
        function createPartitionAreaHtml() {
            let html = '<div style="display: flex; gap: 20px; flex-wrap: wrap;">';
            
            partitions.forEach(partition => {
                const width = partition.size.width * 90; // æ¯ä¸ªåº“ä½å¯¹90pxå®½
                const height = partition.size.height * 65; // æ¯ä¸ªåº“ä½å¯¹65pxé«˜
                
                html += '<div style="border: 2px solid #2196f3; border-radius: 8px; padding: 10px; background-color: #f8f9fa;">';
                html += '<h4 style="margin-bottom: 10px; color: #2196f3;">' + partition.name + '</h4>';
                html += '<div style="display: grid; grid-template-columns: repeat(' + partition.size.width + ', 90px); grid-template-rows: repeat(' + partition.size.height + ', 65px); gap: 10px;">';
                
                const grid = Array(partition.size.height).fill(null).map(() => Array(partition.size.width).fill(null));
                const cells = generateCellsForPartition(partition);
                
                cells.forEach(cell => {
                    if (cell.row < grid.length && cell.col < grid[0].length) {
                        grid[cell.row][cell.col] = cell;
                    }
                });

                for (let row = 0; row < partition.size.height; row++) {
                    for (let col = 0; col < partition.size.width; col++) {
                        const cell = grid[row][col];
                        html += '<div style="min-height: 65px; border: 1px solid #eee; border-radius: 4px; padding: 5px; background-color: #fafafa;">';
                        if (cell && cell.type !== 'empty') {
                            html += renderCellHtml(cell);
                        } else {
                            html += '<div style="visibility: hidden; height: 100%;"><\/div>';
                        }
                        html += '<\/div>';
                    }
                }
                
                html += '<\/div>';
                html += '<\/div>';
            });
            
            html += '<\/div>';
            return html;
        }

        // æ¸²æŸ“å•å…ƒæ ¼HTML - å¤åˆ¶layout.htmlçš„é€»è¾‘
        function renderCellHtml(cell) {
            let html = '<div style="display: flex; justify-content: center; align-items: center; height: 100%;">';
            
            if (cell.type === 'rack_pair_horizontal') {
                html += createRackPairHtml(cell.racks, 'horizontal', cell.status);
            } else if (cell.type === 'rack_pair_vertical') {
                html += createRackPairHtml(cell.racks, 'vertical', cell.status);
            } else if (cell.type === 'aisle') {
                html += '<div style="width: 100%; height: 100%;"><\/div>';
            }
            
            html += '<\/div>';
            return html;
        }

        // åˆ›å»ºåº“ä½å¯¹HTML - å¤åˆ¶layout.htmlçš„é€»è¾‘
        function createRackPairHtml(racks, orientation, status) {
            let html = '<div style="display: ';
            if (orientation === 'horizontal') {
                html += 'flex; gap: 5px; align-items: center; justify-content: center; width: 90px; height: 55px; padding: 5px;">';
            } else if (orientation === 'vertical') {
                html += 'flex; flex-direction: column; gap: 5px; align-items: center; justify-content: center; width: 55px; height: 40px; padding: 5px;">';
            }
            
            racks.forEach(rack => {
                html += createRackHtml(rack, orientation, status);
            });
            
            html += '<\/div>';
            return html;
        }

        // åˆ›å»ºå•ä¸ªåº“ä½HTML - å¤åˆ¶layout.htmlçš„é€»è¾‘
        function createRackHtml(rackId, orientation, status) {
            let html = '<div style="';
            
            // åŸºç¡€æ ·å¼
            html += 'display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; border-radius: 4px; border: 1px solid; cursor: pointer; transition: all 0.3s ease; box-sizing: border-box;';
            
            // æ–¹å‘æ ·å¼
            if (orientation === 'horizontal') {
                html += 'width: 40px; height: 55px;';
            } else if (orientation === 'vertical') {
                html += 'width: 55px; height: 40px;';
            }
            
            // çŠ¶æ€é¢œè‰²
            if (status === 'occupied') {
                html += 'background-color: #e3f2fd; color: #1976d2; border-color: #2196f3;';
            } else if (status === 'warning') {
                html += 'background-color: #fff3e0; color: #f57c00; border-color: #ff9800;';
            } else {
                html += 'background-color: #f8f9fa; color: #666; border-color: #ddd;';
            }
            
            html += '" title="åº“ä½: ' + rackId + '">' + rackId + '<\/div>';
            return html;
        }

        // æ›´æ–°é…ç½®
        function updateConfig() {
            currentConfig = {
                layoutName: document.getElementById('layoutName').value,
                version: "1.0",
                created: new Date().toISOString().split('T')[0],
                dimensions: currentConfig.dimensions,
                baseInfo: baseData,
                racks: placedRacks.map(rack => ({
                    ...rack,
                    status: ['empty', 'occupied', 'warning'][Math.floor(Math.random() * 3)]
                })),
                areaNames: document.getElementById('areaNames').value,
                statistics: {
                    totalRacks: rackPool.length,
                    placedRacks: placedRacks.length,
                    utilization: Math.round((placedRacks.reduce((sum, rack) => sum + (rack.size.width * rack.size.height), 0) / (currentConfig.dimensions.totalWidth * currentConfig.dimensions.totalHeight)) * 100),
                    typeDistribution: {
                        process: placedRacks.filter(r => r.type === 'process').length,
                        storage: placedRacks.filter(r => r.type === 'storage').length,
                        temp: placedRacks.filter(r => r.type === 'temp').length,
                        waste: placedRacks.filter(r => r.type === 'waste').length
                    }
                }
            };
        }

        // è¾…åŠ©å‡½æ•°ï¼šæ›´æ–°åˆ†åŒºé¢„è§ˆ
        function updatePartitionPreview(startX, startY, endX, endY) {
            // è¿™é‡Œå¯ä»¥æ·»åŠ æ‹–æ‹½æ—¶çš„è§†è§‰é¢„è§ˆ
            // ä¸ºäº†ç®€åŒ–ï¼Œæš‚æ—¶ä¸å®ç°
        }

        // è¾…åŠ©å‡½æ•°ï¼šæ¸…é™¤åˆ†åŒºé¢„è§ˆ
        function clearPartitionPreview() {
            // æ¸…é™¤æ‹–æ‹½é¢„è§ˆ
        }

        // è¾…åŠ©å‡½æ•°ï¼šè°ƒæ•´åˆ†åŒºå¤§å°
        function startResize(event, partitionIndex, handle) {
            event.stopPropagation();
            isResizing = true;
            // è¿™é‡Œå®ç°è°ƒæ•´å¤§å°çš„é€»è¾‘
            // ä¸ºäº†ç®€åŒ–ï¼Œæš‚æ—¶ä¸å®ç°å®Œæ•´çš„æ‹–æ‹½è°ƒæ•´
        }

        // è¾…åŠ©å‡½æ•°ï¼šåˆ‡æ¢ç½‘æ ¼æ˜¾ç¤º
        function toggleGrid() {
            const showGrid = document.getElementById('showGrid').checked;
            const grid = document.getElementById('layoutGrid');
            if (grid) {
                grid.style.gap = showGrid ? '2px' : '0px';
            }
        }

        // å¯¼å‡ºé…ç½®
        function exportConfig() {
            updateConfig();
            const configText = JSON.stringify(currentConfig, null, 2);
            document.getElementById('configOutput').value = configText;
            showMessage('é…ç½®å·²å¯¼å‡º', 'success');
        }

        // å¤åˆ¶é…ç½®
        function copyConfig() {
            const configOutput = document.getElementById('configOutput');
            configOutput.select();
            document.execCommand('copy');
            showMessage('é…ç½®å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
        }

        // ä¸‹è½½é…ç½®æ–‡ä»¶
        function downloadConfig() {
            updateConfig();
            const configText = JSON.stringify(currentConfig, null, 2);
            const blob = new Blob([configText], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'warehouse_layout_' + currentConfig.layoutName + '_' + Date.now() + '.json';
            a.click();
            URL.revokeObjectURL(url);
            showMessage('é…ç½®æ–‡ä»¶å·²ä¸‹è½½', 'success');
        }

        // é‡ç½®æ‰€æœ‰
        function resetAll() {
            if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰é…ç½®å—ï¼Ÿ')) {
                loadDefaultConfig();
                rackPool = [];
                placedRacks = [];
                baseData = {};
                selectedPartition = null;
                currentStep = 1;
                dragMode = 'place';
                
                // é‡ç½®æ­¥éª¤æ˜¾ç¤º
                document.getElementById('step1').classList.add('active');
                document.getElementById('step1').classList.remove('completed');
                document.getElementById('step2').classList.add('pending');
                document.getElementById('step2').classList.remove('active');
                document.getElementById('step1Content').style.display = 'block';
                document.getElementById('step2Content').style.display = 'none';
                
                // é‡ç½®è¡¨å•
                document.getElementById('layoutName').value = 'AåŸºåœ°å¸ƒå±€';
                document.getElementById('baseData').value = 'demo';
                document.getElementById('gridWidth').value = '12';
                document.getElementById('gridHeight').value = '8';
                document.getElementById('areaNames').value = '';
                
                // é‡æ–°åŠ è½½æ•°æ®å’Œç½‘æ ¼
                loadBaseData();
                createLayoutGrid();
                updateRackStats();
                
                // é‡ç½®æ‹–æ‹½æ¨¡å¼
                setDragMode('place');
                
                // æ¸…ç©ºé¢„è§ˆ
                document.getElementById('configOutput').value = '';
                showMessage('å·²é‡ç½®ä¸ºé»˜è®¤é…ç½®', 'success');
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(text, type) {
            const message = document.getElementById('message');
            message.textContent = text;
            message.className = 'message ' + type + ' show';
            setTimeout(() => { message.classList.remove('show'); }, 3000);
        }
    </script>
</body>
</html>